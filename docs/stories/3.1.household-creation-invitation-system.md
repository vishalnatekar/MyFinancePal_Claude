# Story 3.1: Household Creation and Invitation System

## Status
Draft

## Story
**As a** user,
**I want** to create a household and invite my partner/flatmates,
**so that** we can start managing shared expenses together.

## Acceptance Criteria
1. Household creation flow with household name and description
2. Email invitation system for adding household members
3. Invitation acceptance/decline workflow with email notifications
4. Household member list with roles (creator, member)
5. Household settings page for managing basic information
6. Leave household functionality with data cleanup
7. Maximum household size limits (e.g., 6 members for performance)
8. Household invitation expiry and resend functionality
9. Email templates for invitations and household updates

## Tasks / Subtasks

- [ ] Task 1: Create household data model and database implementation (AC: 1, 4, 7)
  - [ ] Implement households table with name, description, created_by, settlement_day fields
  - [ ] Implement household_members junction table with roles (creator, member)
  - [ ] Add household size validation (max 6 members)
  - [ ] Set up Row Level Security policies for households and household_members tables

- [ ] Task 2: Implement backend API endpoints for household management (AC: 1, 4, 5, 6)
  - [ ] Create POST /api/households endpoint for household creation
  - [ ] Create GET /api/households endpoint to list user's households
  - [ ] Create GET /api/households/[id] endpoint for household details
  - [ ] Create PUT /api/households/[id] endpoint for household settings updates
  - [ ] Create DELETE /api/households/[id]/members/[userId] for leave functionality
  - [ ] Add Zod validation schemas for all endpoints

- [ ] Task 3: Build household invitation system with email notifications (AC: 2, 3, 8, 9)
  - [ ] Create POST /api/households/[id]/invite endpoint for sending invitations
  - [ ] Implement email invitation templates using Supabase Auth
  - [ ] Create invitation token system with expiry (7 days)
  - [ ] Create GET /api/households/invite/[token] endpoint for invitation acceptance
  - [ ] Add resend invitation functionality with rate limiting

- [ ] Task 4: Create frontend household creation and management UI (AC: 1, 4, 5, 6)
  - [ ] Build CreateHouseholdForm component with name and description fields
  - [ ] Create HouseholdCard component for household display
  - [ ] Implement HouseholdMemberList component with role indicators
  - [ ] Build HouseholdSettingsPage for managing household information
  - [ ] Add leave household confirmation dialog with data cleanup warning

- [ ] Task 5: Implement invitation flow frontend components (AC: 2, 3, 8)
  - [ ] Create InviteMemberModal component with email input
  - [ ] Build InvitationAcceptancePage component for accepting invitations
  - [ ] Add invitation status tracking in household member list
  - [ ] Implement resend invitation functionality in UI

- [ ] Task 6: Add comprehensive testing coverage
  - [ ] Write unit tests for household API endpoints using Jest + Supertest
  - [ ] Create component tests for all household UI components using React Testing Library
  - [ ] Add E2E tests for complete household creation and invitation workflow using Playwright
  - [ ] Test Row Level Security policies for household data access

## Dev Notes

### Previous Story Insights
No previous stories exist - this is the first story implementation.

### Data Models
**Households Table Structure** [Source: architecture/database-schema.md#households-table]:
- id: UUID primary key (auto-generated)
- name: TEXT NOT NULL (household display name)
- description: TEXT (optional household description)
- created_by: UUID REFERENCES users(id) NOT NULL
- settlement_day: INTEGER CHECK (1-31) DEFAULT 1
- created_at: TIMESTAMP WITH TIME ZONE

**Household Members Junction Table** [Source: architecture/database-schema.md#household-members-junction-table]:
- id: UUID primary key
- household_id: UUID REFERENCES households(id) NOT NULL
- user_id: UUID REFERENCES users(id) NOT NULL
- role: TEXT DEFAULT 'member' CHECK (role IN ('creator', 'member'))
- joined_at: TIMESTAMP WITH TIME ZONE
- UNIQUE constraint on (household_id, user_id)

**TypeScript Interfaces** [Source: architecture/data-models.md#household]:
```typescript
interface Household {
  id: string;
  name: string;
  description?: string;
  created_by: string;
  created_at: string;
  settlement_day: number;
}

interface HouseholdMember {
  id: string;
  household_id: string;
  user_id: string;
  role: 'creator' | 'member';
  joined_at: string;
}
```

### API Specifications
**Household Management Endpoints** [Source: architecture/api-specification.md#household-management]:
- GET /api/households - List user's households
- POST /api/households - Create new household (requires name, optional description)
- GET /api/households/[id] - Get household details
- PUT /api/households/[id] - Update household settings
- POST /api/households/[id]/invite - Send member invitation
- GET /api/households/invite/[token] - Accept invitation

**Authentication Requirements** [Source: architecture/api-specification.md#security]:
All endpoints require bearerAuth security with JWT tokens from Supabase Auth.

### Component Specifications
**File Locations Based on Project Structure** [Source: architecture/unified-project-structure.md]:
- Frontend pages: `src/app/(dashboard)/household/` directory
- Backend APIs: `src/app/api/households/` directory
- UI components: `src/components/household/` directory
- TypeScript types: `src/types/household.ts`
- Service layer: `src/services/household-service.ts`
- State management: `src/stores/household-store.ts`

**Component Architecture** [Source: architecture/frontend-architecture.md#component-architecture]:
Components should use TypeScript interfaces, follow PascalCase naming, and integrate with Zustand for state management.

### File Locations
Based on unified project structure, new files should be created at:
- `src/app/(dashboard)/household/create/page.tsx` - Household creation page
- `src/app/(dashboard)/household/page.tsx` - Household list page
- `src/app/(dashboard)/household/[id]/page.tsx` - Household dashboard
- `src/app/(dashboard)/household/[id]/members/page.tsx` - Member management
- `src/app/api/households/route.ts` - Main households API
- `src/app/api/households/[id]/route.ts` - Individual household API
- `src/app/api/households/[id]/invite/route.ts` - Invitation API
- `src/components/household/CreateHouseholdForm.tsx`
- `src/components/household/HouseholdCard.tsx`
- `src/components/household/HouseholdMemberList.tsx`
- `src/types/household.ts`
- `src/services/household-service.ts`
- `src/stores/household-store.ts`

### Technical Constraints
**Authentication** [Source: architecture/backend-architecture.md#authentication-and-authorization]:
- All API routes must call authenticateRequest() helper first
- Use Supabase Auth for user authentication and JWT validation

**Input Validation** [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- Use Zod schemas for all API endpoints and form submissions
- No unvalidated data allowed in the system

**Database Access** [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- Always use Supabase client with Row Level Security policies
- Never use raw SQL queries in API routes

**State Management** [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- Use Zustand actions for all state modifications
- Never mutate state directly

### Testing
**Testing Requirements** [Source: architecture/testing-strategy.md]:
- **Frontend Unit Tests**: Component tests using Jest + React Testing Library
  - Location: `tests/components/household/`
  - Test files: `create-household-form.test.tsx`, `household-card.test.tsx`, `member-list.test.tsx`
- **Backend Unit Tests**: API endpoint tests using Jest + Supertest
  - Location: `tests/api/households/`
  - Test files: `households.test.ts`, `invite.test.ts`
- **E2E Tests**: Complete workflow tests using Playwright
  - Location: `tests/e2e/onboarding/`
  - Test file: `household-creation.spec.ts`

**Test Organization Standards** [Source: architecture/testing-strategy.md#test-organization]:
Follow the testing pyramid with many unit tests, some integration tests, and few E2E tests.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-23 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*