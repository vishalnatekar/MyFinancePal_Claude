# Story 3.2: Account Sharing Privacy Controls

## Status
Approved

## Story
**As a** user,
**I want** to control which of my accounts are visible to household members,
**so that** I can share relevant information while maintaining privacy.

## Acceptance Criteria
1. Account sharing toggle for each connected account (visible/private)
2. Clear visual indicators showing which accounts are shared
3. Shared account data visible in household members' "Household View"
4. Privacy controls persist across account syncs and updates
5. Bulk sharing controls for multiple accounts
6. Account sharing history and audit log
7. Warning prompts when sharing sensitive account types
8. Shared account balance updates reflected in household view
9. Granular sharing (balance only vs full transaction history)

## Tasks / Subtasks

- [ ] Task 1: Extend database schema for account sharing settings (AC: 4, 9)
  - [ ] Add `sharing_level` ENUM field to financial_accounts table ('none', 'balance_only', 'full')
  - [ ] Add `shared_households` JSONB field to financial_accounts for multi-household support
  - [ ] Create account_sharing_history table for audit log (account_id, household_id, action, changed_by, changed_at)
  - [ ] Update RLS policies to support granular sharing levels
  - [ ] Create migration file: database/migrations/007_account_sharing_controls.sql

- [ ] Task 2: Implement backend API endpoints for sharing controls (AC: 1, 4, 5, 6)
  - [ ] Create PUT /api/accounts/[id]/sharing endpoint for single account sharing updates
  - [ ] Create POST /api/accounts/bulk-sharing endpoint for bulk sharing operations
  - [ ] Create GET /api/accounts/[id]/sharing-history endpoint for audit log retrieval
  - [ ] Add Zod validation schemas for sharing level and household selection
  - [ ] Implement sharing history tracking in all sharing update operations
  - [ ] Add validation to prevent sharing accounts if user doesn't belong to target household

- [ ] Task 3: Build account sharing control UI components (AC: 1, 2, 5, 7)
  - [ ] Create AccountSharingToggle component with three states (none/balance_only/full)
  - [ ] Create SharingLevelSelector component with visual icons for sharing levels
  - [ ] Build BulkSharingControls component for multi-select account operations
  - [ ] Create SharingWarningDialog component for sensitive account types (investment, credit)
  - [ ] Add visual indicators (badges, icons) to AccountCard component showing sharing status

- [ ] Task 4: Integrate sharing controls into account management pages (AC: 1, 2, 4, 7)
  - [ ] Update src/app/(dashboard)/accounts/page.tsx with sharing controls column
  - [ ] Add sharing controls to src/app/(dashboard)/accounts/[id]/page.tsx account details
  - [ ] Implement bulk actions toolbar for multi-account sharing updates
  - [ ] Add warning prompts before sharing investment and credit accounts
  - [ ] Display sharing status with clear visual differentiation (color coding, icons)

- [ ] Task 5: Implement household view filtering with privacy controls (AC: 3, 8, 9)
  - [ ] Update GET /api/dashboard/household/[id] to filter accounts by sharing_level
  - [ ] Modify household dashboard queries to include only shared accounts from members
  - [ ] Implement balance-only view (hide transactions when sharing_level = 'balance_only')
  - [ ] Add real-time subscription for shared account balance updates via Supabase
  - [ ] Create SharedAccountsList component for household view with ownership labels

- [ ] Task 6: Create account sharing audit log interface (AC: 6)
  - [ ] Build AccountSharingHistory component displaying audit trail
  - [ ] Add filtering by date range, household, and action type
  - [ ] Display changed_by user information with timestamps
  - [ ] Integrate audit log into account details page as expandable section
  - [ ] Add export functionality for sharing history (CSV format)

- [ ] Task 7: Add comprehensive testing coverage
  - [ ] Write unit tests for account sharing API endpoints (PUT, POST, GET sharing routes)
  - [ ] Create component tests for AccountSharingToggle, BulkSharingControls, SharingWarningDialog
  - [ ] Add integration tests for RLS policies with different sharing levels
  - [ ] Write E2E test for complete sharing workflow (toggle sharing, verify household view, check audit log)
  - [ ] Test edge cases: sharing to non-existent household, revoking sharing, bulk operations

## Dev Notes

### Previous Story Insights
Story 3.1 (Household Creation and Invitation System) established the household infrastructure. Key learnings:
- Household membership is tracked via household_members table with user_id and household_id
- RLS policies use auth.uid() for authentication checks
- Use Zod schemas for all API validation
- Email notifications via Resend service for household events
- Testing pyramid: unit tests → integration tests → E2E tests
- Security definer functions prevent RLS infinite recursion issues (see migration 005)

### Data Models

**Financial Accounts Table - Extended Schema** [Source: architecture/database-schema.md#financial-accounts-table]:

Existing fields:
- id: UUID primary key
- user_id: UUID REFERENCES users(id)
- truelayer_account_id: TEXT (external API identifier)
- account_type: TEXT CHECK IN ('checking', 'savings', 'investment', 'credit', 'loan')
- account_name: TEXT NOT NULL
- institution_name: TEXT NOT NULL
- current_balance: DECIMAL(15,2)
- currency: TEXT DEFAULT 'GBP'
- is_shared: BOOLEAN DEFAULT false (to be replaced)
- is_manual: BOOLEAN DEFAULT false
- last_synced: TIMESTAMP WITH TIME ZONE
- created_at: TIMESTAMP WITH TIME ZONE

**New fields to add in migration 007:**
- sharing_level: TEXT DEFAULT 'none' CHECK (sharing_level IN ('none', 'balance_only', 'full'))
- shared_households: JSONB DEFAULT '[]' (array of household_id values)

**Account Sharing History Table** (New - to be created):
- id: UUID primary key (auto-generated)
- account_id: UUID REFERENCES financial_accounts(id) ON DELETE CASCADE NOT NULL
- household_id: UUID REFERENCES households(id) ON DELETE CASCADE NOT NULL
- action: TEXT NOT NULL CHECK (action IN ('shared', 'unshared', 'level_changed'))
- sharing_level: TEXT (the level set during this action)
- changed_by: UUID REFERENCES users(id) NOT NULL
- changed_at: TIMESTAMP WITH TIME ZONE DEFAULT now()

**TypeScript Interfaces** [Source: architecture/data-models.md#financial-account]:

```typescript
interface FinancialAccount {
  id: string;
  user_id: string;
  truelayer_account_id?: string;
  account_type: 'checking' | 'savings' | 'investment' | 'credit' | 'loan';
  account_name: string;
  institution_name: string;
  current_balance: number;
  currency: string;
  sharing_level: 'none' | 'balance_only' | 'full';
  shared_households: string[]; // array of household IDs
  is_manual: boolean;
  last_synced?: string;
  created_at: string;
}

interface AccountSharingHistory {
  id: string;
  account_id: string;
  household_id: string;
  action: 'shared' | 'unshared' | 'level_changed';
  sharing_level: 'none' | 'balance_only' | 'full';
  changed_by: string;
  changed_at: string;
}
```

### API Specifications

**Account Sharing Endpoints** (New - to be created):

- **PUT /api/accounts/[id]/sharing** - Update sharing settings for single account
  - Request body: `{ household_id: string, sharing_level: 'none' | 'balance_only' | 'full' }`
  - Authentication: Required (must own account)
  - Validation: User must be member of target household
  - Creates entry in account_sharing_history
  - Updates shared_households array and sharing_level field

- **POST /api/accounts/bulk-sharing** - Bulk sharing operations
  - Request body: `{ account_ids: string[], household_id: string, sharing_level: 'none' | 'balance_only' | 'full' }`
  - Authentication: Required (must own all accounts)
  - Validation: All accounts must belong to authenticated user
  - Creates audit log entries for each account
  - Returns success/failure count and error details

- **GET /api/accounts/[id]/sharing-history** - Retrieve audit log
  - Query params: `?household_id=uuid&start_date=YYYY-MM-DD&end_date=YYYY-MM-DD`
  - Authentication: Required (must own account or be household member)
  - Returns paginated history with user details (changed_by name/email)

**Updated Household Dashboard Endpoint**:
- **GET /api/dashboard/household/[id]** - Modified to respect sharing levels
  - Returns accounts from all household members based on their sharing_level
  - Filters transactions when sharing_level = 'balance_only' (balance visible, transactions hidden)
  - Includes full transaction history when sharing_level = 'full'

**Authentication Requirements** [Source: architecture/backend-architecture.md#authentication-and-authorization]:
All endpoints require bearerAuth security with JWT tokens from Supabase Auth. Call authenticateRequest() helper first.

### RLS Policy Updates

**Financial Accounts - Updated Policy** [Source: architecture/database-schema.md#row-level-security-policies]:

Current policy allows viewing shared accounts (is_shared = true). This needs enhancement:

```sql
-- Replace existing "Users can view shared accounts in their households" policy
CREATE POLICY "Users can view shared accounts in their households" ON public.financial_accounts
  FOR SELECT USING (
    sharing_level != 'none' AND user_id IN (
      SELECT hm.user_id FROM public.household_members hm
      WHERE hm.household_id IN (
        SELECT household_id FROM public.household_members
        WHERE user_id = auth.uid()
      )
      AND hm.household_id = ANY(shared_households::uuid[])
    )
  );
```

**Transactions - Granular Sharing Policy**:
Need to add policy that respects balance_only vs full sharing:

```sql
CREATE POLICY "Users can view transactions based on sharing level" ON public.transactions
  FOR SELECT USING (
    account_id IN (
      SELECT fa.id FROM public.financial_accounts fa
      WHERE fa.sharing_level = 'full'
      AND fa.user_id IN (
        SELECT hm.user_id FROM public.household_members hm
        WHERE hm.household_id = ANY(fa.shared_households::uuid[])
        AND hm.household_id IN (
          SELECT household_id FROM public.household_members
          WHERE user_id = auth.uid()
        )
      )
    )
  );
```

### Component Specifications

**File Locations Based on Project Structure** [Source: architecture/unified-project-structure.md]:

**Frontend Pages**:
- `src/app/(dashboard)/accounts/page.tsx` - Existing page, update with sharing controls
- `src/app/(dashboard)/accounts/[id]/page.tsx` - Existing page, add sharing section
- `src/app/(dashboard)/household/[id]/page.tsx` - Existing page, update to filter by sharing_level

**Backend API Routes**:
- `src/app/api/accounts/[id]/sharing/route.ts` - New endpoint for single account sharing
- `src/app/api/accounts/bulk-sharing/route.ts` - New endpoint for bulk operations
- `src/app/api/accounts/[id]/sharing-history/route.ts` - New endpoint for audit log
- `src/app/api/dashboard/household/[id]/route.ts` - Existing, update filtering logic

**Components**:
- `src/components/accounts/AccountSharingToggle.tsx` - New component
- `src/components/accounts/SharingLevelSelector.tsx` - New component
- `src/components/accounts/BulkSharingControls.tsx` - New component
- `src/components/accounts/SharingWarningDialog.tsx` - New component
- `src/components/accounts/AccountSharingHistory.tsx` - New component
- `src/components/household/SharedAccountsList.tsx` - New component
- `src/components/accounts/AccountCard.tsx` - Existing, update with sharing indicators

**Services & Types**:
- `src/types/account.ts` - Update FinancialAccount interface, add AccountSharingHistory
- `src/services/account-service.ts` - Add sharing control methods (updateSharing, bulkUpdateSharing, getSharingHistory)
- `src/lib/validations.ts` - Add Zod schemas for sharing requests

**Database Migration**:
- `database/migrations/007_account_sharing_controls.sql` - Schema changes for granular sharing

### Sharing Level Definitions

**none (default)**: Account not shared with any household. Account and transactions invisible to household members.

**balance_only**: Account balance visible to household members in household view. Transactions hidden. Use case: "Share my savings account balance but not spending details."

**full**: Account balance and full transaction history visible to household members. Use case: "Share my checking account completely for expense tracking."

### Sensitive Account Type Warnings

When user attempts to share accounts of certain types, display warning dialog:

**Investment accounts**: "You're about to share investment account details. This will make your investment holdings visible to household members. Are you sure?"

**Credit accounts**: "Sharing credit card details will show all transactions to household members. Consider using 'Balance Only' for privacy."

**Loan accounts**: "This will share loan balance and payment history with household members."

Warning dialogs should include:
- Clear explanation of what will be shared
- Checkbox: "I understand what information will be shared"
- Buttons: "Cancel" (default), "Share Anyway" (requires checkbox)

### Bulk Sharing Operations

Bulk sharing controls should:
- Allow multi-select via checkboxes on account list
- Display count of selected accounts (e.g., "3 accounts selected")
- Provide dropdown to select target household (if user belongs to multiple)
- Provide dropdown to select sharing level (none/balance_only/full)
- Show confirmation dialog with list of accounts before applying
- Display progress indicator during bulk update
- Show success/failure summary (e.g., "3 accounts updated successfully")

### Real-time Updates

When a household member changes sharing settings, other household members should see updates in real-time:

**Implementation** [Source: architecture/frontend-architecture.md#real-time-subscriptions]:
- Use Supabase real-time subscriptions on financial_accounts table
- Filter subscriptions by household membership
- Update household dashboard automatically when sharing changes
- Show toast notification: "John updated account sharing settings"

**Hook implementation**:
```typescript
// In src/hooks/use-shared-accounts.ts
useEffect(() => {
  const subscription = supabase
    .channel('shared-accounts')
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'financial_accounts',
      filter: `sharing_level=neq.none`
    }, handleAccountUpdate)
    .subscribe();

  return () => subscription.unsubscribe();
}, [householdId]);
```

### UI/UX Considerations

**Visual Sharing Indicators**:
- **Not shared**: Gray icon, text "Private"
- **Balance only**: Blue icon with partial visibility indicator, text "Balance Shared"
- **Full sharing**: Green icon with full visibility indicator, text "Fully Shared"

**Account Card Component Enhancement**:
Add sharing badge to existing AccountCard component:
- Position: Top-right corner of card
- Color coding: Gray (private), Blue (balance only), Green (full)
- Tooltip on hover showing which households can see this account

**Household View Filtering**:
When viewing household dashboard:
- Show account owner name clearly (e.g., "John's Checking Account")
- Display sharing level badge next to each shared account
- For balance_only accounts, show balance but display "Transaction details not shared" message
- For full accounts, show complete transaction list with visual indicator that it's shared data

### Technical Constraints

**Authentication** [Source: architecture/backend-architecture.md#authentication-and-authorization]:
- All API routes must call authenticateRequest() helper first
- Use Supabase Auth for user authentication and JWT validation

**Input Validation** [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- Use Zod schemas for all API endpoints and form submissions
- No unvalidated data allowed in the system

**Database Access** [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- Always use Supabase client with Row Level Security policies
- Never use raw SQL queries in API routes
- Test RLS policies to prevent data leaks across households

**State Management** [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- Use Zustand actions for all state modifications
- Never mutate state directly
- Update account-store.ts with sharing control actions

### Migration Strategy

**Data Migration for Existing Accounts**:
Since existing accounts use `is_shared: BOOLEAN`, migration 007 must:
1. Add new fields (sharing_level, shared_households) with defaults
2. Migrate existing data: `UPDATE financial_accounts SET sharing_level = CASE WHEN is_shared = true THEN 'full' ELSE 'none' END`
3. For accounts where is_shared = true, populate shared_households with all households the user belongs to
4. Drop is_shared column after successful migration
5. Add NOT NULL constraint to sharing_level after migration

**Backward Compatibility**:
During migration window, backend should handle both is_shared (legacy) and sharing_level (new). After all accounts migrated, remove is_shared handling.

### Testing

**Testing Requirements** [Source: architecture/testing-strategy.md]:

**Frontend Unit Tests**:
- Location: `tests/components/accounts/`
- Test files:
  - `account-sharing-toggle.test.tsx` - Test three-way toggle state changes
  - `bulk-sharing-controls.test.tsx` - Test multi-select and bulk operations
  - `sharing-warning-dialog.test.tsx` - Test warning display for sensitive accounts
  - `account-sharing-history.test.tsx` - Test audit log display and filtering

**Backend Unit Tests**:
- Location: `tests/api/accounts/`
- Test files:
  - `sharing.test.ts` - Test PUT /api/accounts/[id]/sharing endpoint
  - `bulk-sharing.test.ts` - Test POST /api/accounts/bulk-sharing endpoint
  - `sharing-history.test.ts` - Test GET /api/accounts/[id]/sharing-history endpoint
- Test RLS policies with different sharing levels and household memberships

**Integration Tests**:
- Test sharing control flow: user shares account → household member sees it in household view
- Test granular sharing: balance_only accounts show balance but hide transactions
- Test audit log creation for all sharing actions
- Test real-time updates when sharing settings change

**E2E Tests**:
- Location: `tests/e2e/core-workflows/`
- Test file: `privacy-controls.spec.ts` (mentioned in PRD testing strategy)
- Test complete workflow:
  1. User creates household and invites member
  2. User connects financial account
  3. User shares account with household (full sharing)
  4. Verify household member sees account in household view
  5. User changes to balance_only sharing
  6. Verify household member sees balance but not transactions
  7. User revokes sharing (none)
  8. Verify household member no longer sees account
  9. Check audit log shows all changes

**Security Testing**:
- Verify users cannot view accounts from households they don't belong to
- Test RLS policies prevent unauthorized sharing updates
- Verify sharing_level filtering works correctly in household queries
- Test bulk operations cannot affect accounts user doesn't own

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-08 | 1.0 | Initial story creation | Product Owner (Sarah) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent after story completion_
